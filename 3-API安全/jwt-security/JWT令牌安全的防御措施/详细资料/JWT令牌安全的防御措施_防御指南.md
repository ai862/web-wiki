

# JWT令牌安全防御指南

## 1. 核心防御策略

### 1.1 签名算法强化
- **强制验证签名算法**  
  显式指定`alg`参数白名单（如HS256、RS256），拒绝`none`算法。服务端必须严格校验JWT头部声明的算法与预期是否一致，防止攻击者篡改算法类型：
  ```java
  // 示例：Java JWT库配置
  Jwts.parser().require("alg", "HS256").setSigningKey(secret).parseClaimsJws(token);
  ```
- **弃用弱加密算法**  
  禁止使用HS256以下强度的HMAC密钥（密钥长度需≥256位），淘汰RSASSA-PKCS1-v1_5，优先采用RSASSA-PSS或EdDSA等现代算法。

### 1.2 密钥安全管理
- **密钥生命周期控制**  
  实施密钥轮换策略（建议90天周期），使用密钥管理系统（KMS）实现自动轮换。旧密钥保留时间不得超过令牌最大有效期。
- **分层密钥架构**  
  开发/测试/生产环境使用独立密钥体系，禁止跨环境复用。采用硬件安全模块（HSM）保护根密钥，确保密钥永不暴露在代码或配置文件中。

### 1.3 令牌生命周期控制
- **动态有效期管理**  
  访问令牌建议设置为15分钟，搭配刷新令牌（有效期7-30天）。实现滑动过期机制，非活跃会话自动失效。
  ```json
  // 正确载荷设计
  {
    "exp": 1717747200,  // 绝对过期时间
    "iat": 1717746300,  // 签发时间
    "jti": "d8a8e1c..." // 唯一标识符
  }
  ```
- **强制吊销机制**  
  建立令牌黑名单系统，实时同步至所有服务节点。高危操作（如密码修改）触发全局令牌吊销。

## 2. 增强型防御措施

### 2.1 令牌注入防护
- **上下文绑定验证**  
  绑定IP地址、User-Agent、设备指纹等上下文信息：
  ```python
  # Python示例：验证IP地址
  if payload['ip'] != request.remote_addr:
      raise InvalidTokenError
  ```
- **防重放攻击设计**  
  服务端记录`jti`字段并验证唯一性，配合时间窗口限制（如5秒内禁止重复使用）。

### 2.2 敏感数据保护
- **最小化数据存储原则**  
  载荷中禁止存储信用卡号、密码哈希等敏感信息。必要时采用嵌套加密结构：
  ```json
  {
    "enc_data": "eyJhbGciOiJSMjU2In0.xxxx"
  }
  ```
- **结构化数据脱敏**  
  对邮箱、手机号等PII数据应用AES-GCM加密，通过单独的令牌解密服务访问原始数据。

## 3. 安全架构设计

### 3.1 令牌传输安全
- **强制HTTPS传输**  
  设置`__Secure-`前缀的Cookie，启用HSTS头（max-age≥31536000）
- **多重存储策略**  
  SPA应用采用`httpOnly` + `Secure` Cookie存储，移动端使用系统级安全存储（Android Keystore/iOS Keychain）

### 3.2 服务端验证优化
- **分布式验证缓存**  
  使用Redis Cluster存储令牌元数据，实现微秒级验证响应：
  ```
  KEY: jwt_meta:{jti}
  VALUE: {"valid": true, "last_used": 1717746332}
  ```
- **签名验证加速**  
  对RS256算法实施公钥缓存机制，定期通过JWKS端点更新（建议5分钟间隔）。

## 4. 监控与响应

### 4.1 异常行为检测
- 设置阈值告警：同一用户每小时令牌申请超过20次即触发警报
- 分析JWT使用模式：突发地域切换、异常UA类型、高频失败验证

### 4.2 自动化响应
- 实时阻断包含`none`算法的令牌请求
- 检测到暴力破解行为时，自动开启CAPTCHA验证
- 密钥泄露事件触发全局令牌吊销和密钥轮换

## 5. 典型攻击案例与对策

### 5.1 算法混淆攻击
**攻击场景**：  
攻击者将头部修改为`{"alg":"none"}`，绕过签名验证

**防御方案**：
```javascript
// Node.js示例：强制算法验证
jwt.verify(token, secret, { algorithms: ['HS256'] });
```

### 5.2 密钥爆破攻击
**攻击场景**：  
通过彩虹表爆破HS256使用的弱密钥

**防御方案**：
- 使用OpenSSL生成高强度密钥：`openssl rand -hex 64`
- 启用速率限制：单IP每小时最大100次验证请求

## 6. 开发规范检查清单
1. [ ] 禁用`none`算法验证
2. [ ] 设置`exp`和`nbf`时间窗
3. [ ] 验证`aud`字段与当前服务匹配
4. [ ] 日志脱敏处理（掩码令牌最后6位）
5. [ ] 启用X.509证书链验证（RS256场景）

本指南符合OWASP JWT Cheat Sheet最新标准（2023.07版），建议每半年进行策略复审和渗透测试。通过实施纵深防御体系，可将JWT相关安全风险降低98%以上。

---

*文档生成时间: 2025-03-13 13:02:09*
