# 模板注入(SSTI)利用链构造技术文档

## 1. 概述

### 1.1 定义
模板注入（Server-Side Template Injection, SSTI）是一种服务器端的安全漏洞，攻击者通过向模板引擎注入恶意代码，从而在服务器端执行任意命令或获取敏感数据。SSTI通常发生在Web应用程序使用模板引擎渲染用户输入时，未对用户输入进行充分的验证和过滤。

### 1.2 原理
模板引擎通常用于将动态数据嵌入到静态HTML页面中。当用户输入被直接传递给模板引擎时，如果未经过适当的处理，攻击者可以插入恶意模板代码，导致服务器执行这些代码。这种漏洞的严重性取决于模板引擎的功能和配置。

## 2. 分类

### 2.1 基于模板引擎的分类
SSTI漏洞可以根据使用的模板引擎进行分类，常见的模板引擎包括：

- **Jinja2**（Python）
- **Twig**（PHP）
- **Freemarker**（Java）
- **Velocity**（Java）
- **Handlebars**（JavaScript）
- **ERB**（Ruby）

### 2.2 基于攻击方式的分类
- **直接注入**：用户输入直接作为模板的一部分被解析和执行。
- **间接注入**：用户输入通过某种方式间接影响模板的生成和执行。

## 3. 技术细节

### 3.1 漏洞检测
检测SSTI漏洞的常见方法包括：

- **输入特殊字符**：如`{{7*7}}`，观察输出是否为`49`。
- **错误信息分析**：通过输入非法模板语法，观察服务器返回的错误信息。

### 3.2 利用链构造
利用链的构造通常包括以下几个步骤：

1. **确定模板引擎**：通过错误信息或特定语法确定使用的模板引擎。
2. **寻找可利用的函数或方法**：不同模板引擎有不同的内置函数或方法，攻击者需要找到可以执行系统命令或访问敏感数据的方法。
3. **构造恶意模板**：将恶意代码嵌入到模板中，使其在服务器端执行。
4. **执行攻击**：通过发送恶意请求，触发模板引擎解析和执行恶意代码。

### 3.3 示例代码

#### 3.3.1 Jinja2 示例
```python
from jinja2 import Template

user_input = "{{ ''.__class__.__mro__[1].__subclasses__()[216]('ls', shell=True, stdout=-1).communicate() }}"
template = Template(user_input)
output = template.render()
print(output)
```
在这个示例中，攻击者通过Jinja2模板引擎的`__class__`和`__subclasses__`方法，找到并执行了`subprocess.Popen`，从而执行了系统命令`ls`。

#### 3.3.2 Twig 示例
```php
$loader = new Twig_Loader_Array(array(
    'index' => '{{ _self.env.registerUndefinedFilterCallback("exec") }}{{ _self.env.getFilter("id") }}',
));
$twig = new Twig_Environment($loader);
echo $twig->render('index');
```
在这个示例中，攻击者通过Twig模板引擎的`_self.env.registerUndefinedFilterCallback`和`_self.env.getFilter`方法，注册并执行了`exec`函数，从而执行了系统命令`id`。

## 4. 攻击向量

### 4.1 常见攻击向量
- **用户输入字段**：如搜索框、评论框等。
- **URL参数**：通过URL传递的参数可能被用于模板渲染。
- **HTTP头**：某些应用程序可能将HTTP头信息用于模板渲染。

### 4.2 高级攻击向量
- **文件上传**：上传的文件名可能被用于模板渲染。
- **API请求**：通过API传递的参数可能被用于模板渲染。

## 5. 防御思路和建议

### 5.1 输入验证和过滤
- **严格验证用户输入**：确保用户输入符合预期的格式和内容。
- **使用白名单**：只允许特定的字符和格式通过。

### 5.2 模板引擎配置
- **禁用危险功能**：如禁用模板引擎中的`eval`、`exec`等危险函数。
- **使用安全的模板引擎**：选择安全性较高的模板引擎，并保持其最新版本。

### 5.3 安全编码实践
- **避免直接使用用户输入**：在模板渲染前，对用户输入进行适当的处理和转义。
- **最小权限原则**：运行模板引擎的进程应具有最小的权限，以减少攻击成功后的影响。

### 5.4 监控和日志
- **监控异常行为**：实时监控模板引擎的执行情况，及时发现异常行为。
- **记录日志**：详细记录模板引擎的执行日志，便于事后分析和追踪。

## 6. 结论
模板注入（SSTI）是一种严重的安全漏洞，攻击者可以通过构造恶意模板代码，在服务器端执行任意命令或获取敏感数据。防御SSTI漏洞需要从输入验证、模板引擎配置、安全编码实践等多个方面入手，综合运用各种安全措施，才能有效降低风险。

通过本文的介绍，希望读者能够深入理解SSTI漏洞的原理和利用链构造方法，并在实际工作中采取有效的防御措施，确保Web应用程序的安全性。

---

*文档生成时间: 2025-03-11 17:35:06* 
