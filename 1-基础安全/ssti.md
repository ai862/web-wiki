# 服务端模板注入 (SSTI) 技术文档

## 1. 概述

服务端模板注入（Server-Side Template Injection, SSTI）是一种严重的安全漏洞，攻击者可以通过在服务端模板引擎中注入恶意代码来执行任意命令或获取敏感信息。SSTI通常发生在应用程序使用模板引擎动态生成HTML、XML或其他文档时，由于未对用户输入进行严格过滤或转义，导致攻击者能够控制模板的渲染过程。

## 2. 定义与原理

### 2.1 定义
SSTI是指攻击者能够将恶意代码注入到服务端模板中，从而在模板渲染时执行这些代码。模板引擎通常用于将动态数据嵌入到静态模板中，生成最终的输出。如果模板引擎允许用户输入直接嵌入到模板中，且未进行适当的过滤或转义，攻击者就可以利用这一点注入恶意代码。

### 2.2 原理
模板引擎在渲染模板时，会将模板中的占位符替换为实际的数据。如果攻击者能够控制这些占位符的内容，就可以注入恶意代码。例如，攻击者可以在用户输入中插入模板语言的表达式，这些表达式在模板渲染时会被执行，从而导致任意代码执行或敏感信息泄露。

## 3. 分类

### 3.1 基于模板引擎的分类
SSTI漏洞的影响范围和利用方式取决于所使用的模板引擎。常见的模板引擎包括：

- **Jinja2**（Python）
- **Twig**（PHP）
- **Freemarker**（Java）
- **Velocity**（Java）
- **Handlebars**（JavaScript）
- **ERB**（Ruby）

每种模板引擎的语法和功能不同，因此SSTI的利用方式也会有所不同。

### 3.2 基于攻击目标的分类
- **代码执行**：攻击者通过注入恶意代码，在服务器上执行任意命令。
- **信息泄露**：攻击者通过注入模板表达式，获取敏感信息，如环境变量、配置文件内容等。

## 4. 技术细节

### 4.1 攻击向量
SSTI的攻击向量通常是通过用户输入传递的。例如，在Web应用程序中，用户输入的表单数据、URL参数、HTTP头等都可能成为攻击向量。攻击者可以通过这些输入将恶意代码注入到模板中。

### 4.2 利用方式
#### 4.2.1 代码执行
攻击者可以通过注入模板语言的表达式来执行任意代码。例如，在Jinja2模板引擎中，攻击者可以注入以下代码来执行系统命令：

```python
{{ ''.__class__.__mro__[1].__subclasses__()[186].__init__.__globals__['__builtins__']['__import__']('os').popen('whoami').read() }}
```

这段代码通过Python的反射机制，获取`os`模块并执行`whoami`命令。

#### 4.2.2 信息泄露
攻击者可以通过注入模板表达式来获取敏感信息。例如，在Twig模板引擎中，攻击者可以注入以下代码来获取环境变量：

```twig
{{ _self.env }}
```

这段代码通过`_self`对象访问环境变量。

### 4.3 示例代码
以下是一个简单的Python Flask应用程序，使用Jinja2模板引擎，存在SSTI漏洞：

```python
from flask import Flask, request, render_template_string

app = Flask(__name__)

@app.route('/')
def index():
    name = request.args.get('name', 'World')
    template = f"<h1>Hello, {name}!</h1>"
    return render_template_string(template)

if __name__ == '__main__':
    app.run(debug=True)
```

在这个示例中，用户输入的`name`参数直接嵌入到模板中，未进行任何过滤或转义。攻击者可以通过`name`参数注入恶意代码，例如：

```
http://localhost:5000/?name={{7*7}}
```

这将导致模板渲染时执行`7*7`，输出`49`。

## 5. 防御思路与建议

### 5.1 输入验证与过滤
- **严格验证用户输入**：确保用户输入符合预期的格式和类型，拒绝不符合要求的输入。
- **过滤特殊字符**：对用户输入中的特殊字符进行过滤或转义，防止其被解释为模板语言的一部分。

### 5.2 使用安全的模板引擎
- **选择安全的模板引擎**：选择那些默认情况下对用户输入进行严格处理的模板引擎。
- **配置模板引擎**：确保模板引擎的配置安全，禁用不必要的功能，如动态代码执行。

### 5.3 最小权限原则
- **限制模板引擎的权限**：确保模板引擎在渲染模板时具有最小的权限，避免其能够执行敏感操作。
- **隔离模板渲染环境**：将模板渲染环境与应用程序的其他部分隔离，防止攻击者通过模板注入获取敏感信息。

### 5.4 安全编码实践
- **避免直接嵌入用户输入**：尽量避免将用户输入直接嵌入到模板中，使用安全的模板变量代替。
- **定期安全审计**：定期对应用程序进行安全审计，发现并修复潜在的SSTI漏洞。

### 5.5 使用安全工具
- **静态代码分析工具**：使用静态代码分析工具扫描代码，发现潜在的SSTI漏洞。
- **动态应用安全测试（DAST）**：使用DAST工具对应用程序进行动态测试，发现并修复SSTI漏洞。

## 6. 总结

服务端模板注入（SSTI）是一种严重的安全漏洞，攻击者可以通过注入恶意代码在服务器上执行任意命令或获取敏感信息。防御SSTI的关键在于严格验证和过滤用户输入，使用安全的模板引擎，并遵循安全编码实践。通过采取这些措施，可以有效减少SSTI漏洞的风险，保护应用程序的安全。

## 7. 参考资源
- [OWASP Server-Side Template Injection](https://owasp.org/www-community/attacks/Server-Side_Template_Injection)
- [Jinja2 Template Engine Documentation](https://jinja.palletsprojects.com/)
- [Twig Template Engine Documentation](https://twig.symfony.com/)
- [Freemarker Template Engine Documentation](https://freemarker.apache.org/)

---

*文档生成时间: 2025-03-11 13:31:01*
