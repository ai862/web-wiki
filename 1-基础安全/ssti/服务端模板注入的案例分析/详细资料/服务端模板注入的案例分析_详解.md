# 服务端模板注入(SSTI)的案例分析

## 1. 概述

服务端模板注入（Server-Side Template Injection, SSTI）是一种安全漏洞，攻击者通过向服务端模板引擎注入恶意代码，从而在服务器上执行任意命令或获取敏感信息。SSTI通常发生在使用模板引擎（如Jinja2、Freemarker、Velocity等）的Web应用程序中，当用户输入未经充分验证和转义时，攻击者可以利用模板引擎的特性执行恶意操作。

本文将深入分析真实世界中的SSTI漏洞案例，探讨攻击者的利用手法，并提供相应的防御策略。

## 2. 案例分析

### 2.1 案例一：Jinja2模板注入

#### 背景
某电商网站使用Flask框架开发，后端模板引擎为Jinja2。网站允许用户通过搜索框输入关键词进行商品搜索，搜索结果页面使用Jinja2模板渲染。

#### 漏洞发现
攻击者在搜索框中输入以下内容：
```python
{{ 7 * 7 }}
```
搜索结果页面显示为“49”，表明Jinja2模板引擎执行了输入的表达式。

#### 攻击利用
攻击者进一步尝试执行系统命令：
```python
{{ ''.__class__.__mro__[1].__subclasses__()[132].__init__.__globals__['popen']('ls').read() }}
```
该代码通过Jinja2的模板语法，利用Python的反射机制，最终执行了`ls`命令并返回了当前目录的文件列表。

#### 漏洞原因
网站未对用户输入进行充分的验证和转义，直接将用户输入嵌入到模板中，导致Jinja2模板引擎执行了恶意代码。

#### 防御措施
- 对用户输入进行严格的验证和转义，避免直接将用户输入嵌入模板。
- 使用安全的模板渲染方法，如Jinja2的`autoescape`功能。

### 2.2 案例二：Freemarker模板注入

#### 背景
某企业内部管理系统使用Spring Boot框架开发，后端模板引擎为Freemarker。系统允许用户通过表单提交数据，并在页面上显示提交的内容。

#### 漏洞发现
攻击者在表单中输入以下内容：
```freemarker
<#assign ex="freemarker.template.utility.Execute"?new()> ${ ex("ls") }
```
提交后，页面显示了当前目录的文件列表，表明Freemarker模板引擎执行了系统命令。

#### 攻击利用
攻击者进一步尝试获取系统敏感信息：
```freemarker
<#assign ex="freemarker.template.utility.Execute"?new()> ${ ex("cat /etc/passwd") }
```
该代码通过Freemarker的模板语法，执行了`cat /etc/passwd`命令，获取了系统的用户信息。

#### 漏洞原因
系统未对用户输入进行充分的验证和转义，直接将用户输入嵌入到模板中，导致Freemarker模板引擎执行了恶意代码。

#### 防御措施
- 对用户输入进行严格的验证和转义，避免直接将用户输入嵌入模板。
- 使用安全的模板渲染方法，如Freemarker的`auto_escape`功能。

### 2.3 案例三：Velocity模板注入

#### 背景
某在线教育平台使用Apache Velocity作为后端模板引擎。平台允许用户通过评论功能提交内容，并在页面上显示评论。

#### 漏洞发现
攻击者在评论框中输入以下内容：
```velocity
#set($exec="exec") $exec.class.forName("java.lang.Runtime").getRuntime().exec("ls")
```
提交后，页面显示了当前目录的文件列表，表明Velocity模板引擎执行了系统命令。

#### 攻击利用
攻击者进一步尝试获取系统敏感信息：
```velocity
#set($exec="exec") $exec.class.forName("java.lang.Runtime").getRuntime().exec("cat /etc/passwd")
```
该代码通过Velocity的模板语法，执行了`cat /etc/passwd`命令，获取了系统的用户信息。

#### 漏洞原因
平台未对用户输入进行充分的验证和转义，直接将用户输入嵌入到模板中，导致Velocity模板引擎执行了恶意代码。

#### 防御措施
- 对用户输入进行严格的验证和转义，避免直接将用户输入嵌入模板。
- 使用安全的模板渲染方法，如Velocity的`escape`功能。

## 3. 攻击手法总结

### 3.1 利用模板引擎的表达式语法
攻击者通过输入模板引擎的表达式语法，如Jinja2的`{{ }}`、Freemarker的`${ }`、Velocity的`#set`等，利用模板引擎的执行能力，执行恶意代码。

### 3.2 利用反射机制
攻击者通过模板引擎的反射机制，访问底层语言（如Python、Java）的类和对象，从而执行系统命令或获取敏感信息。

### 3.3 利用模板引擎的全局变量
攻击者通过模板引擎的全局变量，访问系统环境或执行系统命令，如Jinja2的`__globals__`、Freemarker的`Execute`、Velocity的`Runtime`等。

## 4. 防御策略

### 4.1 输入验证和转义
对用户输入进行严格的验证和转义，避免直接将用户输入嵌入模板。使用安全的模板渲染方法，如Jinja2的`autoescape`、Freemarker的`auto_escape`、Velocity的`escape`等。

### 4.2 限制模板引擎的功能
限制模板引擎的功能，避免执行系统命令或访问敏感信息。使用安全的模板引擎配置，如禁用反射机制、限制全局变量的访问等。

### 4.3 使用安全的开发框架
使用安全的开发框架和模板引擎，避免使用已知存在漏洞的版本。定期更新框架和模板引擎，修复已知的安全漏洞。

### 4.4 安全审计和测试
定期进行安全审计和测试，发现和修复潜在的安全漏洞。使用自动化工具进行漏洞扫描，如OWASP ZAP、Burp Suite等。

## 5. 结论

服务端模板注入（SSTI）是一种严重的安全漏洞，攻击者可以通过注入恶意代码，在服务器上执行任意命令或获取敏感信息。通过分析真实世界中的SSTI漏洞案例，我们可以更好地理解攻击者的利用手法，并采取相应的防御策略。通过严格的输入验证和转义、限制模板引擎的功能、使用安全的开发框架以及定期进行安全审计和测试，可以有效防止SSTI漏洞的发生，保障Web应用程序的安全性。

---

*文档生成时间: 2025-03-11 13:37:36*
